# Plan 08-01: AI Context Injection

## Goal

Send file context with AI requests so the AI can analyze code and generate relevant diagrams. The context store's files will be included in AI prompts.

## Why This Approach

Extend the existing DiagramContext type to include codebase files:
1. Add optional `codebaseContext` string to DiagramContext
2. Modify AIServiceBase.buildSystemPrompt to include codebase files
3. Update ChatPanel to pass context from store

The context will be formatted as:
```
### Codebase Context

The user has provided the following code files. Analyze them to help generate appropriate diagrams.

### File: path/to/file.ts
\`\`\`typescript
// file content
\`\`\`
```

## Tasks

### Task 1: Update DiagramContext type

Add codebaseContext field to DiagramContext in `src/types/ai.ts`:

```typescript
export interface DiagramContext {
  type: string
  content: string
  lastError?: string
  codebaseContext?: string  // New field
}
```

**Verification:**
- [x] DiagramContext type updated
- [x] No TypeScript errors

### Task 2: Update buildSystemPrompt in AIServiceBase

Modify `buildSystemPrompt` to include codebase context:

```typescript
protected buildSystemPrompt(context?: DiagramContext): string {
  let prompt = `...existing prompt...`

  if (context?.codebaseContext) {
    prompt += `\n\n### Codebase Context\n\nThe user has provided the following code files. Analyze them to help generate appropriate Mermaid diagrams.\n\n${context.codebaseContext}`
  }

  if (context?.content) {
    prompt += `\n\nCurrent diagram (${context.type}):\n\`\`\`mermaid\n${context.content}\n\`\`\``
  }

  // ... rest
}
```

**Verification:**
- [x] System prompt includes codebase context
- [x] Context is formatted with file headers
- [x] No TypeScript errors

### Task 3: Update ChatPanel to pass context

Update ChatPanel's handleSendMessage to include codebase context:

```typescript
const context = {
  type: activeTab.diagram.type,
  content: activeTab.diagram.content,
  codebaseContext: contextStore.contextForAI,  // From store getter
}
```

**Verification:**
- [x] Context passed to AI requests
- [x] contextForAI getter provides formatted content
- [x] No TypeScript errors

## Verification

After completing all tasks:

1. **Type check passes:**
   ```bash
   npm run type-check
   ```

2. **Manual testing:**
   - Drop some code files
   - Send message to AI
   - Verify AI response references the code

## Estimated Scope

- **Task 1:** ~2 lines (type update)
- **Task 2:** ~10 lines (prompt update)
- **Task 3:** ~5 lines (ChatPanel update)
- **Total:** ~17 lines
