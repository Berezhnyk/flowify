# Plan 10-01: Token Management

## Goal

Handle large contexts with truncation, smart file selection, and token estimation. When context exceeds limits, truncate intelligently.

## Why This Approach

Simple token estimation:
- ~4 characters per token for English/code
- Set max context size (e.g., 32K tokens = ~128KB)
- Truncate files from end, keeping most important ones

Strategy:
1. Estimate total tokens
2. If over limit, prioritize smaller files and truncate large ones
3. Show warning in UI when context is truncated

## Tasks

### Task 1: Add token estimation utility

Create `src/utils/tokens.ts`:

```typescript
// Rough estimate: ~4 characters per token
export function estimateTokens(text: string): number {
  return Math.ceil(text.length / 4)
}

export const MAX_CONTEXT_TOKENS = 32000 // ~128KB
export const MAX_CONTEXT_CHARS = MAX_CONTEXT_TOKENS * 4

export function truncateContent(content: string, maxChars: number): string {
  if (content.length <= maxChars) return content
  return content.slice(0, maxChars) + '\n\n[... content truncated ...]'
}
```

**Verification:**
- [x] File created at `src/utils/tokens.ts`
- [x] Token estimation function works
- [x] Truncation function works

### Task 2: Add context truncation in store

Update context store with a getter that returns truncated context:

```typescript
const MAX_CONTEXT_CHARS = 128 * 1024 // 128KB

const contextForAI = computed(() => {
  if (files.value.length === 0) return ''

  let result = ''
  let remaining = MAX_CONTEXT_CHARS

  // Sort files by size (smaller first to fit more files)
  const sortedFiles = [...files.value].sort((a, b) => a.size - b.size)

  for (const f of sortedFiles) {
    if (remaining <= 0) break

    const content = f.content.length <= remaining
      ? f.content
      : f.content.slice(0, remaining) + '\n[truncated]'

    result += `### File: ${f.path}\n\`\`\`${f.language}\n${content}\n\`\`\`\n\n`
    remaining -= content.length
  }

  return result
})

const isContextTruncated = computed(() => totalSize.value > MAX_CONTEXT_CHARS)
```

**Verification:**
- [x] Context is truncated when too large
- [x] Smaller files prioritized
- [x] isContextTruncated getter works

### Task 3: Show truncation warning in ContextIndicator

Add warning when context is truncated:

```vue
<span v-if="contextStore.isContextTruncated" class="truncation-warning">
  (truncated)
</span>
```

**Verification:**
- [x] Warning shows when context is truncated
- [x] Styled appropriately

## Verification

After completing all tasks:

1. **Type check passes:**
   ```bash
   npm run type-check
   ```

2. **Manual testing:**
   - Load a large codebase (>100KB)
   - Verify truncation warning appears
   - Verify AI still receives usable context

## Estimated Scope

- **Task 1:** ~15 lines (token utility)
- **Task 2:** ~25 lines (store update)
- **Task 3:** ~10 lines (UI warning)
- **Total:** ~50 lines
